name: openrocket
base: core22
grade: stable
confinement: strict
adopt-info: openrocket
summary: A free, fully featured model rocket simulator.
description: |
  OpenRocket is a free, fully featured model rocket simulator...

architectures:
  - build-on: [amd64]
  - build-on: [arm64]
  - build-on: [armhf]
  - build-on: [ppc64el]
  - build-on: [s390x]

apps:
  openrocket:
    command: bin/launcher
    plugs:
      - home
      - network
      - cups-control
      - opengl
      - x11
      - wayland
      - desktop
      - desktop-legacy
      - gsettings
      - dot-java-user-prefs-openrocket
      - dot-openrocket
    environment:
      JAVA_HOME: "$SNAP/usr/lib/jvm/java-17-openjdk-$SNAP_ARCH"

plugs:
  dot-java-user-prefs-openrocket:
    interface: personal-files
    write:
      - $HOME/.java/.userPrefs/OpenRocket
  dot-openrocket:
    interface: personal-files
    write:
      - $HOME/.openrocket

parts:
  openrocket:
    plugin: nil
    source: .
    build-packages:
      - openjdk-17-jdk
      - ca-certificates
      - ca-certificates-java
      - unzip
    stage-packages:
      - openjdk-17-jre
      - ca-certificates
      - ca-certificates-java
    override-build: |
      set -eux

      # Prepare local Gradle home (keeps cache inside the part)
      export GRADLE_USER_HOME="$CRAFT_PART_BUILD/.gradle"

      # If Launchpad provided proxies, map them to Gradle system properties
      write_proxy_props() {
        proto="$1" ; var="${proto}_proxy"
        url="${!var:-}"
        [ -z "$url" ] && return 0
        # strip scheme, take host and port
        host_port="$(printf %s "$url" | sed -E 's#^[a-z]+://##' | cut -d/ -f1)"
        host="${host_port%%:*}"
        port="${host_port##*:}"
        {
          echo "systemProp.${proto}.proxyHost=${host}"
          echo "systemProp.${proto}.proxyPort=${port}"
          # optional: bypass for common local nets
          echo "systemProp.${proto}.nonProxyHosts=localhost|127.0.0.1|10.*|192.168.*|*.internal"
        } >> "$GRADLE_USER_HOME/gradle.properties"
      }
      mkdir -p "$GRADLE_USER_HOME"
      : > "$GRADLE_USER_HOME/gradle.properties"
      write_proxy_props http
      write_proxy_props https

      # --- Ensure wrapper JVM starts without ZGC for armhf, ppc64el, and s390x ---
      ARCH="$(dpkg --print-architecture)"
      if [ "$ARCH" = "armhf" ]; then
        # If the project edited gradlew’s DEFAULT_JVM_OPTS to include ZGC, remove it.
        sed -i 's/"-XX:+UseZGC"//g' ./gradlew || true
        # Also neutralize env-provided JVM opts if any
        unset JAVA_TOOL_OPTIONS _JAVA_OPTIONS
        # Force safe daemon opts
        echo 'org.gradle.jvmargs=-Xmx1024m -XX:+UseG1GC' >> "$GRADLE_USER_HOME/gradle.properties"
      fi

      # Build
      ./gradlew --no-daemon -g "$GRADLE_USER_HOME" clean jar

      # Pick jar
      JAR="$(ls -1 build/libs/OpenRocket-*.jar | head -n1)"
      install -Dm644 "$JAR" "$CRAFT_PART_INSTALL/OpenRocket.jar"

      # Short version (≤32 chars)
      VERSION="$(git describe --tags --abbrev=7 --always 2>/dev/null || echo 0.0.0)"
      VERSION="${VERSION#v}"; VERSION="${VERSION:0:32}"
      craftctl set version="$VERSION"
    prime:
      # If you actually want to keep HTTPS working, delete these three lines:
      - -usr/lib/jvm/java-*/lib/security/cacerts
      - -usr/lib/jvm/java-*/jre/lib/security/cacerts
      - -usr/lib/jvm/java-*/lib/security/blacklisted.certs

  launcher:
    plugin: dump
    source: snap/local
    source-type: local
    organize:
      launcher: bin/launcher
